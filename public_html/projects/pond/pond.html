<!DOCTYPE html>

<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
        <script src="fluent.js"></script>
        <script src="lodash.min.js"></script>
        
        <style>
            svg{
                border: 1px solid;
            }
            
            circle{
                fill: blue;
            }
            
            circle.visited{
                fill: green;
            }
            circle.selected{
                fill: red;
                r: 10;
                
            }
            
        </style>
    </head>
    <body>
        
        <script>
            
            var positionable = ['x', 'y'];
            var rectangular = ['width', 'height'];
            
            function Circle(){
                
                
            }
            Fluent.object(Circle)
                .addProperties(positionable)
                .addProperty('r');
            Circle.prototype.draw = function(){
                return "Drawing Circle: " + this.toString();
            }
            Circle.prototype.toString = function(){
                return "x: " + this.x() + ", y: " + this.y() + ", r: " + this.r();
            }
            
            
            function Rectangle(x, y, width, height){
                
            }
            Fluent.object(Rectangle)
                .addProperties(positionable)
                .addProperties(rectangular);
            Rectangle.prototype.draw = function(){
                return "Drawing Rectangle: " + this.toString();
            }
            Rectangle.prototype.area = function(){
                return this.width() * this.height();
            }
            Rectangle.prototype.toString = function(){
                return "x: " + this.x() + ", y: " + this.y() + ", width: " + this.width() + ", height: " + this.height();
            }
            
            
            
            var circle = new Circle();
            console.log(circle.x(1).y(2).r(3).draw());
            
            var rectangle = new Rectangle().x(10).y(30).width(100).height(30);
            console.log(rectangle.draw());
            
            
            console.log(new Rectangle().width(2).height(3).area());
            
            
            
            var width = 1200;
            var height = 500;
            var mouse = [0,0];
            var svg = d3.select('body')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .on('mousemove', function(){
                    mouse = d3.mouse(this);
                });
            
            
            
            function makePositionable(object){
//                Fluent.object(object)
//                    .addProperty('x')
//                    .addProperty('y');    
                Fluent.object(object).addProperties(['x','y']);
            }
            
            
            var Fleck = function(){
                
                return this;
            }
            
            makePositionable(Fleck);
            
            Fleck.prototype.move = function(x,y){
                this.x(x).y(y);
                return this;
            }
            
            
            var pond = [];
            
            d3.range(100).forEach(function(d){
                pond.push(
                    new Fleck()
                        .x(Math.random() * width)
                        .y(Math.random() * height)
                );
            });
            
            
            var circles = svg.selectAll('circle.fleck')
                    .data(pond)
                    .enter()
                    .append('circle')
                    .attr('class', 'fleck')
                    .attr('cx', function(d){return d.x()})
                    .attr('cy', function(d){return d.y()})
                    .attr('r', 1)
                    .attr('fill', 'black');
                
            
            
            
            function draw(){

//                join.attr('transform', function(d){
//                    return 'translate(' + d.x() + ',' +d.y() + ')';
//                });
                
                var quadtree = d3.geom.quadtree()
                    .extent([[-1,-1],[width+1, height+1]])(pond.map(function(d){
                        var t = [d.x(), d.y()];
                        t.__data__ = d;
                        return t;
                    }));
                
//                var nodes = [];
//                quadtree.visit(function(node, x1, y1, x2, y2){
//                    nodes.push({x: x1, y: y1, width: x2 - x1, height: y2 - y1});
//                });
//                
//                svg.selectAll('rect.node')
//                    .data(nodes)
//                    .enter()
//                    .append('rect')
//                    .attr('x', function(d){return d.x})
//                    .attr('y', function(d){return d.y})
//                    .attr('width', function(d){return d.width})
//                    .attr('height', function(d){return d.height})
//                    .style('fill', 'none')
//                    .style('stroke', '#ccc')
//                    .style('shape-rendering', 'crispEdges')
//                    ;
                
                
                var searchRadius = 100;
                var searchExtent = [[mouse[0] - searchRadius, mouse[1] - searchRadius],[mouse[0] + searchRadius, mouse[1] + searchRadius]];
                
                
                var d = Math.pow(searchRadius, 2);
                
                
                var visited = 0;
                
                
                
                var close = [];
                quadtree.visit(function(node, x1, y1, x2, y2){
                    
                    visited += 1;

                    var p = node.point;
                    /*
                    if (p && p.__data__){
                        p.__data__.selected = false;  
                        p.__data__.visited = false;  
                    } 
                    */

                    
                    if (p) {
                        //p.__data__.visited = true;
                        
                        if (Math.pow(mouse[0] - node.x, 2) + Math.pow(mouse[1] - node.y, 2) < d){
                            close.push()
                        }
                        
                        //p.__data__.selected = nearby;
                    }
                    
                    var x0 = searchExtent[0][0];
                    var y0 = searchExtent[0][1];
                    var x3 = searchExtent[1][0];
                    var y3 = searchExtent[1][1];
                    
                    
                    
                    return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
                    
                });
                
               
                
                
            }
            
            draw();
            
            d3.timer(function(t){
                draw();  
            })
            
                        
            
        </script>
        
        
    </body>
</html>